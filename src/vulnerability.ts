/* --------------------------------------------------------------------------------------------
 * Copyright (c) Red Hat
 * Licensed under the Apache-2.0 License. See License.txt in the project root for license information.
 * ------------------------------------------------------------------------------------------ */
'use strict';

import { Diagnostic, DiagnosticSeverity } from 'vscode-languageserver';
import { Range } from 'vscode-languageserver';
import { IDependencyProvider } from './collector';
import { DependencyData } from './componentAnalysis';
import { RHDA_DIAGNOSTIC_SOURCE } from './constants';

/**
 * Stores vulnerability data of a specific dependency.
 */
class Vulnerability {
    /**
     * Creates a new instance of Vulnerability.
     * @param provider - The dependency provider of the corresponding ecosystem.
     * @param range - The text range within the document.
     * @param ref - The reference name of the dependency.
     * @param dependencyData - All vulnerability data regarding the dependency.
     */
    constructor(
        private provider: IDependencyProvider,
        private range: Range,
        private ref: string,
        private dependencyData: DependencyData[],
      ) {}

    /**
     * Creates a diagnostic object based on vulnerability data.
     * @returns A Diagnostic object representing the vulnerability.
     */
    getDiagnostic(): Diagnostic {

        const diagSeverity = DiagnosticSeverity.Error;

        let msg: string = `${this.provider.resolveDependencyFromReference(this.ref)}`;

        this.dependencyData.forEach(dd => {
            msg += `
            
${dd.sourceId} vulnerability info:
Known security vulnerabilities: ${dd.issuesCount}
Highest severity: ${dd.highestVulnerabilitySeverity}`;
        });

        return {
            severity: diagSeverity,
            range: this.range,
            message: msg,
            source: RHDA_DIAGNOSTIC_SOURCE,
        };
    }
}

export { Vulnerability };