/* --------------------------------------------------------------------------------------------
 * Copyright (c) Red Hat, Dharmendra Patel 2020
 * Licensed under the Apache-2.0 License. See License.txt in the project root for license information.
 * ------------------------------------------------------------------------------------------ */
'use strict';
import { Diagnostic, DiagnosticSeverity } from 'vscode-languageserver';
import { Range } from 'vscode-languageserver';

const AnalyticsSource = '\nDependency Analytics Plugin [Powered by Snyk]';

/* Vulnerability data along with package name and version */
class Vulnerability {
    ecosystem: string;
    name: string;
    version: string;
    packageCount: number;
    vulnerabilityCount: number;
    advisoryCount: number;
    exploitCount: number;
    highestSeverity: string;
    recommendedVersion: string;
    range: Range;
    issuesCount: number;
    refName: string;
    refVersion: string;
    recommendation: any;
    recommendationName: string;
    recommendationVersion: string;
    remediations: any;
    highestVulnerabilitySeverity: string;

    constructor(
        name: string,
        version: string, 
        packageCount: number,
        vulnerabilityCount: number, 
        advisoryCount: number,
        exploitCount: number, 
        highestSeverity: string,
        recommendedVersion: string, 
        range: Range,
        issuesCount: number = 0,
        refName: string = null,
        refVersion: string = null,
        recommendation: any = null,
        recommendationName: string = null,
        recommendationVersion: string = null,
        remediations: any = null,
        highestVulnerabilitySeverity: string = null,
        ) {
        this.name = name;
        this.version = version;
        this.packageCount = packageCount || 0;
        this.vulnerabilityCount = vulnerabilityCount || 0;
        this.advisoryCount = advisoryCount || 0;
        this.exploitCount = exploitCount || 0;
        this.highestSeverity = highestSeverity;
        this.recommendedVersion = recommendedVersion;
        this.range = range;
        this.issuesCount = issuesCount || 0;
        this.refName = refName || '';
        this.refVersion = refVersion || '';
        this.recommendation = recommendation || null;
        this.recommendationName = recommendationName || '';
        this.recommendationVersion = recommendationVersion || '';
        this.remediations = remediations || null;
        this.highestVulnerabilitySeverity = highestVulnerabilitySeverity || '';
    }

    getDiagnostic(): Diagnostic {
        /* The diagnostic's severity. */
        let diagSeverity: any;
        let msg: string;

        if (this.ecosystem === 'maven') {

            if (this.issuesCount === 0) {
                diagSeverity = DiagnosticSeverity.Information;

                if (this.recommendation !== null) {
                    msg = `${this.refName}:${this.refVersion}
Recommendation: ${this.recommendationName}:${this.recommendationVersion}`;
                } else {
                    msg = `${this.refName}:${this.refVersion}
Recommendation: No RedHat packages to recommend`;
                }

            } else {
                diagSeverity = DiagnosticSeverity.Error;

                msg = `${this.refName}:${this.refVersion}
Known security vulnerabilities: ${this.issuesCount}
Highest severity: ${this.highestVulnerabilitySeverity}
Has remediation: ${Object.keys(this.remediations).length > 0 ? 'Yes' : 'No'}`;
            }

            return {
                severity: diagSeverity,
                range: this.range,
                message: msg,
                source: AnalyticsSource,
            };

        } else {

            if (this.vulnerabilityCount === 0 && this.advisoryCount > 0) {
                diagSeverity = DiagnosticSeverity.Information;
            } else {
                diagSeverity = DiagnosticSeverity.Error;
            }

            const recommendedVersion = this.recommendedVersion || 'N/A';
            const exploitCount = this.exploitCount || 'unavailable';
            let numberOfPackagesMsg = '';
            let packageName = this.name;
            if (this.ecosystem === 'golang') {
                numberOfPackagesMsg = `\nNumber of packages: ${this.packageCount}`;
                const parts = this.name.split('@');
                packageName = parts.length === 2 ? parts[1] : packageName;
            }
            msg = `${packageName}: ${this.version}${numberOfPackagesMsg}
    Known security vulnerability: ${this.vulnerabilityCount}
    Security advisory: ${this.advisoryCount}
    Exploits: ${exploitCount}
    Highest severity: ${this.highestSeverity}
    Recommendation: ${recommendedVersion}`;

            return {
                severity: diagSeverity,
                range: this.range,
                message: msg,
                source: AnalyticsSource,
            };

        }
    }
}

export { Vulnerability, AnalyticsSource };
